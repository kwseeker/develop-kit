# 支付系统架构设计

+ **商品服务**

  + **查询商品信息**(价格、名称等)

  + **虚拟物品发货**

    虚拟物品发货是更新数据库数据，每个商品的发货逻辑可能都不一样，所以需要在商品服务中。

+ **下单服务**
  + **创建订单**
  + **更新订单**
  + **查询订单状态**

+ **支付服务**

  各种支付流程差异很大，如何抽象统一的流程？

  + **代币支付**

    1) 余额是否充足

    2) 

  + **普通微信支付**

  + **QQMP代理微信支付**

+ **发货服务**

  + **虚拟物品发货**

    调用商品服务的发货逻辑

  + **实物发货**

+ **前端调用**

  + **查询支持的支付方式**

  + **代币支付**

    商户平台流程：

    １）余额查询

    ２）发起代币支付

    ​	　创建订单、支付、发货一站式处理，最后返回结果。

  + **回调式第三方支付**

    + **微信支付**

      | 支付流程                                       | 普通微信支付                                         | QQMP代理微信支付                                             |
      | ---------------------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------ |
      | １）创建订单，拉起支付                         |                                                      |                                                              |
      | ２）支付回调，检查支付状态，更新订单状态、发货 | 微信支付后台回调商户后台回调接口（不用关心）         | 微信支付后台回调小程序后台回调接口，小程序后台再回调商户后台回调接口（不用关心） |
      | ３）查看订单状态                               | 如果订单未完成，还需主动请求微信支付后台核对支付状态 |                                                              |

    + **QQ钱包支付**

      商户平台流程（和微信支付基本相同）：

      １）创建订单，拉起支付

      ２）支付回调，检查支付状态，更新订单状态、发货

      ３）查看订单状态

    + **AliPay**

      和微信支付类似，只是拉起的是支付宝APP。

